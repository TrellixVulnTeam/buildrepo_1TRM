# buildrepo
Скрипт сборки APT репозиториев Debian-подобной ОС

## Возможности
* Изолированная сборка пакетов;
* Не требует создания отдельной виртуальной машины для сборки исходников;
* Пакеты собираются на заранее развернутых минимальных образах системы - chroot'ов;
* Одновременная сборка нескольких репозиториев на одной хостовой ОС;
* Механизм создания репозиториев "основного" ISO, "средств разработки", разрешенных по Runtime зависимостям и ISO с исходными текстами.

## Требования
* ОС Linux.
* Python3 >= 3.5.
* Модуль `apt` для Python3.
* Необходимые исполняемые файлы для выполнения операций: `systemd-nspawn`, `debootstrap`, `reprepro`, `xorrisofs`.

## Описание конфигурационного файла

Любая операция требует конфигурационного файла репозитория. Путь к конфигурационному файлу может быть задан:
* Переменной окружения `BUILDREPO_CONF`;
* Ключом `--config`.

Конфигурационный файл является файлом в формате INI и состоит из нескольких секций:
* `common` - содержит общие параметры, которые используются командами;
* `chroot` - параметры создания образа целевой ОС для сборки пакетов;
* `build` - параметры, используемые при сборке пакетов;
* `binary-repo` - параметры, используемые при формировании ISO репозиториев.

### Секция `common`

|Наименование параметра| Описание | Обязательный | Примечание |
|-|-|-|-|
|`build-root` | Каталог дерева сборки | нет | По умолчанию: `./build` |
|`repo-name` | Имя репозитория | да  ||
|`repo-version` | Версия репозитория | да  ||

### Секция `chroot`

|Наименование параметра| Описание | Обязательный | Примечание |
|-|-|-|-|
|`distro` | Имя дистрибутива, для которого собирается репозиторий | да ||
|`chroot-helper` | Путь к скрипту, выполняющий сборку пакетов в chroot'е | нет | По умолчанию: `./chroot-helper.sh` |
|`mirror<N>` | Зеркала для создания `chroot` | да| Параметр `N` описывает порядковый номер зеркала. Зеркал может быть несколько. При этом с первого зеркала выполяется `debootstrap`, а остальные используются для установки требуемых для сборки пакетов, например, `dpkg-dev`, `fakeroot` и т.д.|
|`chroot-script` | Имя скрипта для выполнения `debootstrap` | нет | Если не указан, то команда `debootstrap` использует локальные скрипты, установленные в `/usr/share/debootstrap/scripts`|
|`build-user`| Пользователь, от имени которого выполняется сборка пакетов | нет | По умолчанию: `builder` |
|`root-pwd-hash`| Хэш суперпользователя `root` для запуска контейнера в режиме `boot`| нет | Если не указан, то пароль суперпользователю `root` не будет установлен при создании chroot'а|
|`components`| Секции пакетов для выполнения `debootstrap` и регистрации репозиториев в контейнере | нет | По умолчанию: `main, contrib, non-free` |
|`debs` | Список пакетов, которые будут установлены в chroot | нет | По умолчанию дополнительных пакетов не устанавливается. При необходимости задать несколько пакетов, они разделяются запятой `,`|
|`init-scripts-dir`| Каталог скриптов, исполняемые при запуске сборки пакетов в контейнере | нет ||

### Секция `build`
|Наименование параметра| Описание | Обязательный | Примечание |
|-|-|-|-|
|`source-list` | Файл, содержащий список исходников для сборки | да ||

### Секция `binary-repo`
|Наименование параметра| Описание | Обязательный | Примечание |
|-|-|-|-|
|`white-list`| Файл, содержащий список бинарных пакетов, которые попадут на первый диск репозитория | да ||
|`dev-package-suffixes`| Суффиксы бинарных пакетов для принудительного перемещения таких пакетов на второй диск | нет | По умолчанию: `dbg, dbgsym, doc, dev`. Несколько элементов должны разделяться запятой `,`|
|`source-include`| Список файлов, которые будут дополнительно записаны на ISO с исходными текстами | нет | По умолчанию дополнительных файлов не записывается. При необходимости указания нескольких файлов они должны быть разделены запятой `,`|
|`binary-include`| Список файлов, которые будут дополнительно записаны на бинарный ISO | нет | По умолчанию дополнительных файлов не записываеся. При необходимости указания нескольких файлов они должны быть разделены запятой `,`|
|`drop-dbg-packages`| `yes`, если требуется, чтобы все пакеты с отладочными символами не попадали на 2й диск | нет | По умолчанию файлы отладочных символов не удаляются при формировании бинарных репозиториев|
|`creation-timestamp`| временная метка в формате `ДД.ММ.ГГГГ ЧЧ:ММ`, проставляемая на файлы в репозитории | нет | По умолчанию используется текущая метка времени - время запуска скрипта|

### Секция `hashsums`
Данная секция полностью опциональна и содержит пары <алгоритм хэширования> = <путь к утилите хэширования>.
Для каждой пары после создания ISO образов с репозиториями выполняется запуск утилиты хэширования на каждый ISO.
Результаты сохраняются в файл контрольных сумм, расположенных в том же каталоге, что и созданные ISO.


## Описание командного интерфейса
### `init`

Данная команда выполняет первичную инициализацию репозитория, а именно создает каталоги в `build-root`:
- `chroots` - каталог с эталонными образами ОС;
- `chrootinst` - каталог с распаковаенными образами ОС, в которых производится сборка пакетов;
- `iso` - каталог с ISO репозиториев и исходными текстами;
- `tmp` - каталог для создания временных каталогов;

Помимо этого, для каждого репозитория создаются каталоги в `build-root` следующего вида:
- `cache/<distro>/<repo-name>` - содержит кэши репозиториев (в т.ч. и сборочного для разрешения зависимостей), в каталоге `cache/<distro>` содержатся кэши установочного диска и диска со средствами разработки (если он есть);
- `logs/<distro>/<repo-name>` - логи сборки пакетов. В каталоге `logs/<distro>` содержится лог создания chroot'а под указанный дистрибутив;
- `repo/<distro>/<repo-name>` - каталог бинарного репозитория;
- `src/<distro>/<repo-name>` - каталог с исходными текстами пакетов.

Централизованный лог скрипта ведется по пути `<build-root>/build-<repo-name>`.

Данная команда также проверяет факт инициализации указанных каталогов. Для переинициализации используется ключ `--force`.

### `make-chroot`

Данная команда выполняет создание chroot, копирует скрипт сборки пакетов, определнный параметром `chroot-helper`, а также создает пользователя, от имени которого выполняется сборка пакетов (параметр `build-user`).

Если сборочный репозиторий требует для сборки пакеты из других репозиториев, то они должны быть указаны параметрами `mirror<N>`. При этом следует учесть порядок занесения источников - источник, указанный параметром `mirror0` является основным при первичной инцициализации (`debootstrap`).

Дополнительно можно указать дополнительные пакеты, которые будут установлены в образ системы параметром `debs`.

### `login-chroot`

Данная команда используется для входа в распакованный экземпляр chroot и выполнения произвольных действий.

Опция `--deploy` используется для распаковки экземпляра chroot, если он не создан.
Для входа в ОС необходимо назначить пароль суперпользователю `root`(например, параметром `root-pwd-hash` при создании chroot'а).

Если указана опция `--overlay`, то корневая ФС контейнера монтируется в overlay, т.е. изменения ФС контейнера будут потеряны при его выключении.

При подключении к контейнеру могут быть дополнительно замонтированы каталоги опцией `--bind`. Корректный формат аргумента опции:
`<путь-в-хостовой-ФС>:<путь-в-гостевой-ФС>`.

### `build`

Команда `build` используется для сборки пакетов согласно порядку сборк и пакетов, указанного в `source-list`.

Каждая строка этого файла может представлять как имя пакета исходного кода, так и строку вида:
`source version`, где `version` - версия пакета исходных текстов, которая будет собрана.

При анализе списка сборки пропускаются пакеты, которые уже собраны в репозитории. При необходимости пересборки пакета исходных текстов указывается опцией `--rebuild`. Для пересборки всех пакетов используется опция `--rebuild-all`.

Указание опции `--jobs` определяет количество потоков сборки. По умолчанию: `2`.

### `make-package-cache`

Данная команда создает кэш информации по составу пакетов в репозитории, включая зависимости между ними. Кэши репозиториев необходимы для разрешения зависимостей собранных пакетов командой `make-repo` и разделения на диски.

Данная команда требует указания точки монтирования с помощью аргумента командной строки `--mount-point`, относительно которого ищутся файлы, содержащие информацию о компонентах репозиторев (файлы `Packages`, `Packages.gz`).

Параметр `--name` определяет имя кэша. Параметром `--type` определяется тип репозитория. Допустимые типы:
* `os` - основной диска ОС;
* `os-dev` - диск со средствами разработки ОС;
* `ext` - основной диск дополнительного программного продукта, используемый при сборке исходных текстов;
* `ext-dev` - диск со средствами разработки ОС дополнительного программного продукта.

### `make-repo`

Данная команда используется для создания бинарных репозиториев, пакеты которых разрешены относительно всех используемых при сборке репозиториев по полю `Depends` пакета Debian.

Для выполнения этой команды необходимо указание `white-list` в конфигурационном файле скрипта.

Файл `white-list` должен содержать секцию `[target]` со списком бинарных пакетов, попадающих на основной диск. Опцией `dev-package-suffixes` определяются суффиксы пакетов, которые должны попасть на диск со средствами разработки.

Алгоритм анализа необходимых бинарных пакетов на основном диске копирует все зависимости, расположенныemе в сборочном репозитории, проверяет удовлетворение остальных зависимостей на основных дисках (ОС и дополнительных программных продуктов). Для принудительной отправки бинарного пакета на диск со средствами разработки в секцию `[black-list]` заносятся необходимые пакеты.

Если зависимость не найдена в созданных ранее кэшах или найдена на диске со средствами разработки, то создание репозиториев завершается ошибкой.

### `check-runtime-deps`

Для каждого собранного пакета выводит зависимости пакета, если они не были удовлетворены или находятся на дисках со средствами разработки.

### `order-sources`

Выполняет сортировку исходных текстов, указанных в `source-list`, в порядке разрешения сборочных зависимостей относительно репозиториев. Сначала в список будут добавлены все пакеты исходных текстов, которым не требуются бинарные пакеты, собираемые из пакетов исходных текстов сборочного репозитория, далее - имеющие одну, две и т.д.

### `remove-sources`

Данная команда используется для удаления исходных текстов и собираемых бинарных файлов из них. Опцией `--package` передается имя пакетов исходных текстов. Если требуется удалить и файл оригинальных текстов, указывается опция `--remove-orig`.

### `refresh-repo`

Данная команда используется для актуализации файлов репозиториев `Packages`, используемых при сборке дистрибутива.

Опция `--deploy` используется для распаковки экземпляра chroot, если он не создан.

Опция `--type` позволяет задать тип репозитория для актуализации. Доступно два варианта: `os-nb` (репозиторий бинарных пакетов, которые не пересобираются) и `builded` - репозиторий бинарных пакетов, которые собираются из исходных текстов.
